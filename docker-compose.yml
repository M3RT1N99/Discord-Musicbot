services:
  musicbot:
    build:
      context: .
      dockerfile: dockerfile
    container_name: discord-musicbot
    restart: unless-stopped

    environment:
      # Discord Bot Configuration
      - TOKEN=${TOKEN}

      # yt-dlp Configuration
      - YTDLP_PATH=${YTDLP_PATH:-/opt/venv/bin/yt-dlp}
      - DOWNLOAD_DIR=${DOWNLOAD_DIR:-/app/downloads}

      # Cache Configuration
      - MAX_CACHE=${MAX_CACHE:-200}

      # Timeout Configuration (in seconds)
      - DOWNLOAD_TIMEOUT_SEC=${DOWNLOAD_TIMEOUT_SEC:-120}
      - SEARCH_TIMEOUT_SEC=${SEARCH_TIMEOUT_SEC:-30}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # Node Environment
      - NODE_ENV=${NODE_ENV:-production}

    volumes:
      # Persistent storage for downloads and cache
      - musicbot-downloads:/app/downloads
      - musicbot-logs:/app/logs
      # Optional: Mount .env file if you prefer file-based config
      # - ./.env:/app/.env:ro

      # Optional: Mount source code for development
      # - ./src:/app/src:ro

      # Network mode for better performance (optional)
      # Use host network if you have issues with voice connections
      # network_mode: host

    networks:
      - musicbot-network

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Health check
    healthcheck:
      test: [ "CMD", "node", "-e", "process.exit(0)" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  # Persistent volumes for data
  musicbot-downloads:
    driver: local
  musicbot-logs:
    driver: local

networks:
  musicbot-network:
    driver: bridge
